# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

orbs:
  aws-eks: circleci/aws-eks@2.1.1
  kubernetes: circleci/kubernetes@1.3.0
  docker: circleci/docker@2.0.2

jobs:
  build-and-push:
    executor: docker/docker
    steps:
      - setup_remote_docker
      - checkout
      - docker/check
      - docker/build:
          image: heliohealthtest/circle-ci-poc 
      - docker/push:
          digest-path: /tmp/digest.txt
          image: heliohealthtest/circle-ci-poc
      - run:
          command: |
            echo "Digest is: $(</tmp/digest.txt)"
      - restore_cache:
          key: v1-{{ .Branch}}
          paths:
            - /caches/demo-0.0.1-SNAPSHOT.jar
  build-jar:
    docker:
      - image: 'cimg/openjdk:17.0.2' 
    steps:
      - checkout
      - run: mvn test package
      - save_cache:
          key: v1-{{ .Branch }}-{{ epoch }}
          paths:
            - /caches/demo-0.0.1-SNAPSHOT.jar
  cluster-setup:
    docker:
      - image: 'cimg/python:3.10'
    parameters:
      cluster-name:
        description: |
          Name of the EKS cluster
        type: string
    steps:
      - kubernetes/install
      - aws-eks/update-kubeconfig-with-authenticator:
          cluster-name: << parameters.cluster-name >>
      - run:
          command: |
            kubectl get services
          name: circleci poc cluster
workflows:
  build-docker-image:
    jobs:
      - build-jar
      - docker/publish:
          image: $DOCKER_REGISTRY_USER/$DOCKER_REGISTRY_REPO
          update-description: true
          use-docker-credentials-store: true
          requires:
            - build-jar
 # deployment:
 #   jobs:
 #     - aws-eks/create-cluster:
 #         cluster-name: circle-poc-cluster
 #     - cluster-setup:
 #         cluster-name: circle-poc-cluster
 #         requires:
 #           - aws-eks/create-cluster
 #     # TODO: remove this
 #     - aws-eks/delete-cluster:
 #         cluster-name: circle-poc-cluster
 #         requires:
 #           - cluster-setup
 # maven_test:
 #   jobs:
 #     - maven/test:
 #         executor:
 #           name: maven/default
 #           tag: "17.0.2"
